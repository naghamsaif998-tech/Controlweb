<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة فريق العمل</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; direction: rtl; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 500px; margin: auto; }
        input, select, button { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #d63384; color: white; border: none; cursor: pointer; font-weight: bold; }
        .error { color: red; font-size: 14px; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2>إضافة مسؤول جديد</h2>
    <div id="err-msg" class="error"></div>
    
    <input type="text" id="adm-name" placeholder="الاسم الوظيفي">
    <input type="email" id="adm-email" placeholder="البريد الإلكتروني">
    <input type="password" id="adm-password" placeholder="كلمة السر (6 رموز فأكثر)">
    
    <select id="adm-role">
        <option value="moderator">مشرف</option>
        <option value="admin">مسؤول كامل</option>
    </select>
    
    <button id="save-btn" onclick="addAdmin()">إنشاء حساب المسؤول</button>
</div>

<script>
    const S_URL = 'https://yboxheficowekfzjatti.supabase.co';
    const S_KEY = 'sb_publishable_a482mpjOWq2R5Bil808Vng_DObZcycS';
    const _sb = supabase.createClient(S_URL, S_KEY);

    async function addAdmin() {
        const name = document.getElementById('adm-name').value;
        const email = document.getElementById('adm-email').value;
        const password = document.getElementById('adm-password').value;
        const role = document.getElementById('adm-role').value;
        const btn = document.getElementById('save-btn');
        const err = document.getElementById('err-msg');

        if (password.length < 6) {
            err.innerText = "كلمة السر يجب أن تكون 6 خانات فأكثر";
            err.style.display = 'block';
            return;
        }

        btn.disabled = true;
        btn.innerText = "جاري الحفظ...";
        err.style.display = 'none';

        // 1. إنشاء الحساب في Auth
        const { data: authData, error: authError } = await _sb.auth.signUp({
            email: email,
            password: password,
            options: { data: { username: name } }
        });

        if (authError) {
            btn.disabled = false;
            btn.innerText = "إنشاء حساب المسؤول";
            err.innerText = "خطأ 422: تأكدي من إيقاف (Confirm Email) في Supabase أو أن البريد غير مكرر.";
            err.style.display = 'block';
            return;
        }

        // 2. ربط الصلاحيات (إرسال نص Text متوافق مع الجدول)
        const { error: permError } = await _sb.from('admin_permissions').insert([{
            user_id: authData.user.id,
            role: role,
            permissions: "full_access" 
        }]);

        if (permError) {
            alert("تم إنشاء الحساب، ولكن فشل تعيين الصلاحيات (Error 403). يرجى تفعيل RLS Policies للجدول.");
        } else {
            alert("✅ تم إنشاء المسؤول بنجاح!");
            location.reload();
        }
        btn.disabled = false;
    }
</script>
</body>
</html>
