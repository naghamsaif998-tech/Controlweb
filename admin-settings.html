<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ | ÙÙ„Ø§Ù…Ù†ÙƒÙˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --main: #d63384; --bg: #f8f9fa; --danger: #dc3545; --success: #28a745; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; }
        .header { background: linear-gradient(135deg, var(--main), #9d174d); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #444; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; outline: none; box-sizing: border-box; }
        .btn { padding: 14px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--main); color: white; }
        .btn-primary:disabled { background: #ccc; }
        .alert { padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none; font-size: 14px; text-align: center; border: 1px solid; }
        .alert-error { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .alert-success { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .alert-warning { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .admins-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .admins-table td, .admins-table th { padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-size: 14px; }
        .role-badge { background: #e3f2fd; color: #0d47a1; padding: 4px 8px; border-radius: 8px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="header">
        <h1><i class="fas fa-user-shield"></i> Ø¥Ø¯Ø§Ø±Ø© ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h1>
        <p>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙˆØªØ­Ø¯ÙŠØ¯ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹</p>
    </div>

    <div class="card">
        <div id="status-msg" class="alert"></div>

        <div class="input-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø§Ù„Ù„Ù‚Ø¨):</label>
            <input type="text" id="adm-name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙŠÙ… (Ø¥Ø¯Ø§Ø±Ø©)">
        </div>

        <div class="input-group">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¯Ø®ÙˆÙ„:</label>
            <input type="email" id="adm-email" placeholder="admin@example.com">
        </div>

        <div class="input-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</label>
            <input type="password" id="adm-password" placeholder="ÙŠØ¬Ø¨ Ø£Ù† Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† 6 Ø£Ø­Ø±Ù">
        </div>

        <div class="input-group">
            <label>Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
            <select id="adm-role">
                <option value="moderator">Ù…Ø´Ø±Ù (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª)</option>
                <option value="admin">Ù…Ø³Ø¤ÙˆÙ„ (ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©)</option>
            </select>
        </div>
        
        <button class="btn btn-primary" id="save-btn" onclick="createNewAdminAccount()">
            <i class="fas fa-save"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆØªÙØ¹ÙŠÙ„Ù‡
        </button>
    </div>

    <div class="card">
        <h3 style="margin-top:0;"><i class="fas fa-users"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
        <div style="overflow-x: auto;">
            <table class="admins-table">
                <thead><tr><th>Ø§Ù„Ù…Ø¹Ø±Ù (user_id)</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="admins-list"></tbody>
            </table>
        </div>
    </div>

<script>
    const S_URL = 'https://yboxheficowekfzjatti.supabase.co';
    const S_KEY = 'sb_publishable_a482mpjOWq2R5Bil808Vng_DObZcycS'; // anon key
    const _sb = supabase.createClient(S_URL, S_KEY);

    function showMsg(text, type) {
        const msg = document.getElementById('status-msg');
        msg.className = `alert ${type}`;
        msg.innerText = text;
        msg.style.display = 'block';
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©)
    async function fetchAdmins() {
        const { data, error } = await _sb.from('admin_permissions').select('user_id, role');
        
        if (error) {
            console.error("Fetch Error:", error);
            if (error.status === 403 || error.code === '42501') {
                showMsg("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø³ÙŠØ§Ø³Ø© (Policy) Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ admin_permissions.", "alert-error");
            } else {
                showMsg("âŒ Ø®Ø·Ø£: " + error.message, "alert-error");
            }
            return;
        }

        const tbody = document.getElementById('admins-list');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø¹Ø¯</td></tr>';
            return;
        }

        for (const adm of data) {
            // Ø¹Ø±Ø¶ user_id Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ profiles)
            tbody.innerHTML += `
                <tr>
                    <td><small style="direction:ltr; display:inline-block;">${adm.user_id}</small></td>
                    <td><span class="role-badge">${adm.role}</span></td>
                    <td><button onclick="removeAdmin('${adm.user_id}')" style="color:var(--danger); border:none; background:none; cursor:pointer;"><i class="fas fa-trash-alt"></i></button></td>
                </tr>`;
        }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
    async function createNewAdminAccount() {
        const name = document.getElementById('adm-name').value.trim();
        const email = document.getElementById('adm-email').value.trim();
        const password = document.getElementById('adm-password').value;
        const role = document.getElementById('adm-role').value;
        const btn = document.getElementById('save-btn');

        if (!name || !email || password.length < 6) {
            return showMsg("âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± 6+ Ø£Ø­Ø±Ù)", "alert-error");
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';

        // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Auth
        const { data: authData, error: authError } = await _sb.auth.signUp({
            email: email,
            password: password,
            options: { data: { username: name } }
        });

        if (authError) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆØªÙØ¹ÙŠÙ„Ù‡';
            
            let errorMsg = authError.message;
            if (authError.status === 422) errorMsg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø£Ùˆ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚ÙŠØ¯Ø©.";
            return showMsg("âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + errorMsg, "alert-error");
        }

        // 2. Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© INSERT ÙÙŠ Ø¬Ø¯ÙˆÙ„ admin_permissions)
        const { error: permError } = await _sb.from('admin_permissions').insert({
            user_id: authData.user.id,
            role: role,
            permissions: "all_access_granted" // Ù†Øµ Ø¹Ø§Ø¯ÙŠ (Text)
        });

        if (permError) {
            console.error("Insert Error:", permError);
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø®Ø·Ø£ 403 (Ø±ÙØ¶ Ø¨Ø³Ø¨Ø¨ RLS)
            if (permError.status === 403 || permError.code === '42501') {
                showMsg("âš ï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ù„ÙƒÙ† ÙØ´Ù„ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ø³Ø¨Ø¨ Ø³ÙŠØ§Ø³Ø§Øª RLS. Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø³Ø© INSERT Ù„Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Supabase Dashboard.", "alert-warning");
            } else {
                showMsg("âš ï¸ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ù„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: " + permError.message, "alert-warning");
            }
        } else {
            showMsg("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­!", "alert-success");
        }

        fetchAdmins(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ÙˆØªÙØ¹ÙŠÙ„Ù‡';
    }

    // Ø­Ø°Ù Ù…Ø³Ø¤ÙˆÙ„
    async function removeAdmin(userId) {
        if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ØŸ")) return;
        
        const { error } = await _sb.from('admin_permissions').delete().eq('user_id', userId);
        if (error) {
            showMsg("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + error.message, "alert-error");
        } else {
            showMsg("âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­", "alert-success");
            fetchAdmins();
        }
    }

    // ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª (ØªØ¸Ù‡Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„)
    async function checkSetup() {
        const { error } = await _sb.from('admin_permissions').select('user_id').limit(1);
        if (error && (error.status === 403 || error.code === '42501')) {
            showMsg("ğŸ”§ ØªØ°ÙƒÙŠØ±: ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ø³ÙŠØ§Ø³Ø§Øª RLS Ù„Ù„Ø¬Ø¯ÙˆÙ„ admin_permissions (Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„Ø¬Ù…ÙŠØ¹ØŒ ÙˆÙ„ÙƒÙ† ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø³ÙŠØ§Ø³Ø© INSERT Ù„Ù„Ø¥Ø¯Ø±Ø§Ø¬).", "alert-warning");
        }
        fetchAdmins();
    }

    window.onload = checkSetup;
</script>
<!-- 
    ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø³Ø§Øª (Ø§ÙØ¹Ù„Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ø¨Ø± SQL ÙÙŠ Supabase):
    1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ SQL Editor ÙÙŠ Supabase Dashboard.
    2. Ù†ÙØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©:

    -- Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© (Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
    CREATE POLICY "Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹" ON admin_permissions
    FOR SELECT USING (true);

    -- Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ø¥Ø¯Ø±Ø§Ø¬ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…)
    CREATE POLICY "Ø¥Ø¯Ø±Ø§Ø¬ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…" ON admin_permissions
    FOR INSERT WITH CHECK (auth.role() = 'authenticated');

    -- Ø³ÙŠØ§Ø³Ø© Ù„Ù„Ø­Ø°Ù (Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø· - Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ)
    CREATE POLICY "Ø­Ø°Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡Ù…" ON admin_permissions
    FOR DELETE USING (auth.role() = 'authenticated');
-->
</body>
</html>
