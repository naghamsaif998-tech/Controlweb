<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة فريق العمل | فلامنكو</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --main: #d63384; --bg: #f8f9fa; --danger: #dc3545; --success: #28a745; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #eee; }
        .card-title { color: var(--main); font-weight: bold; margin-bottom: 20px; border-bottom: 2px solid #fce4ec; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: bold; color: #555; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--main); box-shadow: 0 0 5px rgba(214, 51, 132, 0.2); }
        .btn-primary { background: var(--main); color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); }
        .admins-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .admins-table th { background: #fff5f8; padding: 12px; text-align: right; color: var(--main); border-bottom: 2px solid #eee; }
        .admins-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        #user-suggestions { position: absolute; background: white; border: 1px solid #ddd; width: 100%; z-index: 100; display: none; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f9f9f9; transition: 0.2s; }
        .suggestion-item:hover { background: #fff5f8; color: var(--main); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; background: #eee; }
        .badge-admin { background: #e3f2fd; color: #0d47a1; }
    </style>
</head>
<body>

    <div class="card">
        <div class="card-title"><i class="fas fa-user-shield"></i> تعيين مسؤول جديد</div>
        
        <label>البحث عن المستخدم:</label>
        <div style="position: relative;">
            <input type="text" id="user-search" placeholder="اكتب اسم المستخدم للبحث..." oninput="searchUsers(this.value)">
            <div id="user-suggestions"></div>
        </div>

        <div id="selected-box" style="display:none; background:#e8f5e9; padding:15px; border-radius:10px; margin-bottom:15px; border: 1px solid #c8e6c9;">
            <i class="fas fa-check-circle" style="color:var(--success)"></i> المستخدم المختار: <strong id="sel-name"></strong>
            <input type="hidden" id="sel-uid">
        </div>

        <label>كلمة مرور الإدارة (الخاصة بالدخول للوحة):</label>
        <input type="password" id="admin-pass" placeholder="حدد كلمة سر قوية">

        <label>الصلاحية الوظيفية:</label>
        <select id="role-select">
            <option value="admin">مسؤول (Admin)</option>
            <option value="moderator">مشرف (Moderator)</option>
            <option value="super_admin">مدير عام (Super Admin)</option>
        </select>

        <button class="btn-primary" onclick="saveAdmin()"><i class="fas fa-save"></i> حفظ وتفعيل الصلاحيات</button>
    </div>

    <div class="card">
        <div class="card-title"><i class="fas fa-users-cog"></i> أعضاء فريق الإدارة</div>
        <div style="overflow-x: auto;">
            <table class="admins-table">
                <thead>
                    <tr>
                        <th>الاسم</th>
                        <th>الرتبة</th>
                        <th>كلمة المرور</th>
                        <th>إجراء</th>
                    </tr>
                </thead>
                <tbody id="admins-list">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        const _sb = supabase.createClient('https://yboxheficowekfzjatti.supabase.co', 'sb_publishable_a482mpjOWq2R5Bil808Vng_DObZcycS');

        // البحث عن المستخدمين في جدول profiles
        async function searchUsers(q) {
            if(q.length < 2) {
                document.getElementById('user-suggestions').style.display = 'none';
                return;
            }
            const { data, error } = await _sb.from('profiles').select('id, username').ilike('username', `%${q}%`).limit(5);
            const list = document.getElementById('user-suggestions');
            if (data && data.length > 0) {
                list.innerHTML = data.map(u => `<div class="suggestion-item" onclick="selectUser('${u.id}', '${u.username}')"><i class="fas fa-user"></i> ${u.username}</div>`).join('');
                list.style.display = 'block';
            } else {
                list.style.display = 'none';
            }
        }

        // اختيار المستخدم من القائمة
        function selectUser(id, name) {
            document.getElementById('sel-uid').value = id;
            document.getElementById('sel-name').innerText = name;
            document.getElementById('selected-box').style.display = 'block';
            document.getElementById('user-suggestions').style.display = 'none';
            document.getElementById('user-search').value = name;
        }

        // حفظ المسؤول في جدول admin_permissions
        async function saveAdmin() {
            const uid = document.getElementById('sel-uid').value;
            const pass = document.getElementById('admin-pass').value.trim();
            const role = document.getElementById('role-select').value;

            if(!uid || !pass) return alert("يرجى اختيار مستخدم وتحديد كلمة مرور أولاً");

            const { error } = await _sb.from('admin_permissions').upsert({
                user_id: uid,
                role: role,
                admin_password: pass,
                permissions: ['novels', 'users'] // صلاحيات افتراضية
            });

            if(error) {
                alert("خطأ: " + error.message);
            } else {
                alert("تم تعيين المسؤول بنجاح ✅");
                location.reload(); 
            }
        }

        // عرض قائمة المسؤولين الحاليين
        async function loadAdmins() {
            try {
                const { data: admins } = await _sb.from('admin_permissions').select('*');
                const { data: users } = await _sb.from('profiles').select('id, username');
                
                const tbody = document.getElementById('admins-list');
                if (!admins || admins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">لا يوجد مسؤولين حالياً</td></tr>';
                    return;
                }

                tbody.innerHTML = admins.map(a => {
                    const user = users.find(u => u.id === a.user_id);
                    return `
                        <tr>
                            <td><strong>${user?.username || '---'}</strong></td>
                            <td><span class="badge badge-admin">${a.role}</span></td>
                            <td><code>${a.admin_password}</code></td>
                            <td><button onclick="deleteAdmin('${a.user_id}')" style="color:var(--danger); border:none; background:none; cursor:pointer;"><i class="fas fa-trash"></i></button></td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error("خطأ في تحميل البيانات:", err);
            }
        }

        // حذف مسؤول
        async function deleteAdmin(uid) {
            if(!confirm("هل أنت متأكد من سحب صلاحيات الإدارة من هذا المستخدم؟")) return;
            const { error } = await _sb.from('admin_permissions').delete().eq('user_id', uid);
            if(!error) loadAdmins();
        }

        window.onload = loadAdmins;
    </script>
</body>
</html>
