<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة البلاغات | فلامنكو</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --main: #d63384; --bg: #f5f5f5; --danger: #dc3545; --success: #28a745; --warning: #ffc107; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 15px; direction: rtl; }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 15px; color: var(--main); text-decoration: none; font-weight: bold; font-size: 14px; }
        .header { background: linear-gradient(135deg, var(--main), #9d174d); color: white; padding: 20px; text-align: center; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(214, 51, 132, 0.2); }
        .header h1 { margin: 0; font-size: 1.5rem; }
        .alert { padding: 15px; border-radius: 10px; margin-bottom: 15px; display: none; font-weight: bold; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 10001; box-shadow: 0 5px 15px rgba(0,0,0,0.2); text-align: center; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .report-card { background: white; padding: 18px; border-radius: 15px; margin-bottom: 15px; border-right: 6px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .report-card.pending { border-right-color: var(--warning); }
        .report-card.resolved { border-right-color: var(--success); opacity: 0.8; }
        .actions { display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 12px; border: none; border-radius: 10px; cursor: pointer; color: white; flex: 1; text-align: center; font-size: 13px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-ignore { background: #6c757d; }
        .btn-warn { background: var(--warning); color: #333; }
        .btn-delete { background: var(--danger); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; max-width: 400px; width: 90%; }
        textarea { width: 100%; height: 100px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="alert-box" class="alert"></div>
    <a href="index.html" class="back-btn"><i class="fas fa-arrow-right"></i> العودة للرئيسية</a>

    <div class="header">
        <h1>إدارة البلاغات</h1>
    </div>

    <div id="loading" style="text-align: center; padding: 40px; color: var(--main);">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br><p>جاري جلب البلاغات...</p>
    </div>

    <div id="reports-list"></div>

    <div id="warn-modal" class="modal">
        <div class="modal-content">
            <h3 style="margin:0;">إرسال تحذير</h3>
            <textarea id="warn-message" placeholder="اكتب سبب التحذير..."></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-warn" onclick="sendWarning()">إرسال</button>
                <button class="btn btn-ignore" onclick="closeModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://yboxheficowekfzjatti.supabase.co';
        const SB_KEY = 'sb_publishable_a482mpjOWq2R5Bil808Vng_DObZcycS';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let _targetUser = null;

        async function init() {
            try {
                const { data, error } = await _sb.from('reports').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                renderReports(data);
            } catch (err) {
                showAlert('error', 'فشل الجلب: ' + err.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderReports(reports) {
            const list = document.getElementById('reports-list');
            if (!reports || reports.length === 0) {
                list.innerHTML = '<p style="text-align:center;">لا توجد بلاغات.</p>';
                return;
            }

            list.innerHTML = reports.map(r => `
                <div class="report-card ${r.status}">
                    <div style="font-size:12px; color:#999;">${new Date(r.created_at).toLocaleString('ar-EG')}</div>
                    <p><b>السبب:</b> ${r.reason}</p>
                    <p style="font-size:13px; color:#666;"><b>المُبلغ ضده (ID):</b> ${r.reported_user || 'غير محدد'}</p>
                    <div class="actions">
                        <button class="btn btn-ignore" onclick="updateStatus('${r.id}', 'resolved')">حل البلاغ</button>
                        <button class="btn btn-warn" onclick="openWarn('${r.reported_user}')">تحذير المستخدم</button>
                        <button class="btn btn-delete" onclick="deleteReport('${r.id}')">حذف البلاغ</button>
                    </div>
                </div>
            `).join('');
        }

        async function updateStatus(id, status) {
            const { error } = await _sb.from('reports').update({ status }).eq('id', id);
            if (!error) { showAlert('success', 'تم التحديث'); init(); }
        }

        async function deleteReport(id) {
            if(!confirm("حذف سجل البلاغ؟")) return;
            const { error } = await _sb.from('reports').delete().eq('id', id);
            if (!error) { showAlert('success', 'تم الحذف'); init(); }
        }

        function openWarn(userId) {
            if(!userId || userId === 'null') return alert("معرف المستخدم غير موجود");
            _targetUser = userId;
            document.getElementById('warn-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('warn-modal').style.display = 'none'; }

        async function sendWarning() {
            const msg = document.getElementById('warn-message').value.trim();
            if(!msg) return;
            // إرسال تنبيه في جدول الإشعارات (تأكدي أن اسم الجدول notifications)
            const { error } = await _sb.from('notifications').insert({
                recipient_id: _targetUser,
                title: "تحذير إداري",
                message: msg
            });
            if(!error) { showAlert('success', 'تم الإرسال'); closeModal(); }
            else { showAlert('error', 'خطأ في الإرسال'); }
        }

        function showAlert(type, msg) {
            const box = document.getElementById('alert-box');
            box.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
            box.innerHTML = msg; box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }

        window.onload = init;
    </script>
</body>
</html>

