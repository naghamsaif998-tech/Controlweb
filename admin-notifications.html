<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الإشعارات | فلامنكو</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --main: #d63384; --secondary: #9d174d; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); direction: rtl; margin: 0; padding: 20px; }
        .header { background: linear-gradient(135deg, var(--main), var(--secondary)); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { color: var(--main); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { background: var(--main); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; }
        .btn:hover { background: var(--secondary); }
        .notif-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 5px solid var(--main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .notif-header { display: flex; justify-content: space-between; font-weight: bold; color: var(--main); }
        #loading { text-align: center; padding: 50px; }
        .user-suggestion { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .user-suggestion:hover { background: #f0f0f0; }
        #suggestions { border: 1px solid #ddd; display: none; max-height: 150px; overflow-y: auto; background: white; position: absolute; width: 90%; z-index: 10; }
        .back-btn { display: inline-block; margin-bottom: 15px; color: var(--main); text-decoration: none; font-weight: bold; }
        .relative { position: relative; }
    </style>
</head>
<body>

    <a href="admin-dashboard.html" class="back-btn"><i class="fas fa-arrow-right"></i> عودة للوحة التحكم</a>

    <div class="header">
        <h1><i class="fas fa-bell"></i> نظام الإشعارات</h1>
        <p>إرسال تنبيهات عامة أو خاصة للمستخدمين</p>
    </div>

    <div class="container">
        <h2><i class="fas fa-paper-plane"></i> إرسال إشعار جديد</h2>
        <div class="form-group">
            <label>نوع الإشعار</label>
            <select id="type" onchange="document.getElementById('user-sec').style.display = this.value === 'general' ? 'none' : 'block'">
                <option value="general">إشعار عام (للجميع)</option>
                <option value="private">إشعار خاص (لمستخدم محدد)</option>
                <option value="warning">تحذير (لمستخدم محدد)</option>
            </select>
        </div>

        <div class="form-group relative" id="user-sec" style="display:none;">
            <label>ابحث عن المستخدم (بالاسم أو الإيميل)</label>
            <input type="text" id="user-search" oninput="searchUsers(this.value)" placeholder="اكتب للبحث..." autocomplete="off">
            <div id="suggestions"></div>
            <input type="hidden" id="target-id">
            <div id="selected-name" style="margin-top:5px; color: green; font-weight: bold;"></div>
        </div>

        <div class="form-group">
            <label>العنوان</label>
            <input type="text" id="title" placeholder="عنوان الرسالة">
        </div>

        <div class="form-group">
            <label>المحتوى</label>
            <textarea id="message" rows="3" placeholder="اكتب نص الإشعار هنا..."></textarea>
        </div>

        <button class="btn" onclick="sendNotif()"><i class="fas fa-share"></i> إرسال الآن</button>
    </div>

    <div class="container">
        <h2><i class="fas fa-history"></i> الإشعارات المرسلة مؤخراً</h2>
        <div id="loading"><i class="fas fa-spinner fa-spin"></i> جاري تحميل البيانات...</div>
        <div id="notif-list"></div>
    </div>

    <script>
        // تحديث الرابط والمفتاح الجديد
        var S_URL = 'https://yboxheficowekfzjatti.supabase.co';
        var S_KEY = 'sb_publishable_a482mpjOWq2R5Bil808Vng_DObZcycS'; 
        var _sb; 
        var allUsers = [];

        async function initPage() {
            try {
                if (typeof window.supabase === 'undefined') {
                    document.getElementById('loading').innerHTML = "فشل تحميل المكتبة، تأكد من الإنترنت.";
                    return;
                }

                if (!_sb) {
                    _sb = window.supabase.createClient(S_URL, S_KEY);
                }

                const { data: authData } = await _sb.auth.getUser();
                
                // جلب بيانات المستخدمين من جدول profiles
                const { data: usersData } = await _sb.from('profiles').select('id, username, email').limit(1000);
                allUsers = usersData || [];

                loadNotifications();
            } catch (err) {
                console.error("Error:", err);
                document.getElementById('loading').innerHTML = "حدث خطأ: " + err.message;
            }
        }

        function searchUsers(query) {
            const sugBox = document.getElementById('suggestions');
            if (!query) { sugBox.style.display = 'none'; return; }

            const filtered = allUsers.filter(u => 
                (u.username && u.username.toLowerCase().includes(query.toLowerCase())) || 
                (u.email && u.email.toLowerCase().includes(query.toLowerCase()))
            ).slice(0, 5);

            sugBox.innerHTML = filtered.map(u => `
                <div class="user-suggestion" onclick="selectUser('${u.id}', '${u.username || u.email}')">
                    ${u.username || 'بدون اسم'} (${u.email})
                </div>
            `).join('');
            sugBox.style.display = filtered.length ? 'block' : 'none';
        }

        function selectUser(id, name) {
            document.getElementById('target-id').value = id;
            document.getElementById('selected-name').innerText = "تم اختيار: " + name;
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('user-search').value = name;
        }

        async function sendNotif() {
            const title = document.getElementById('title').value;
            const message = document.getElementById('message').value;
            const type = document.getElementById('type').value;
            const targetId = document.getElementById('target-id').value;

            if (!title || !message) return alert("يرجى ملء البيانات");
            if (type !== 'general' && !targetId) return alert("يرجى اختيار مستخدم");

            // تم التأكد من استخدام جدول notifications
            const { error } = await _sb.from('notifications').insert([{
                title: title,
                message: message,
                type: type,
                recipient_id: type === 'general' ? null : targetId
            }]);

            if (error) {
                alert("خطأ في الإرسال: " + error.message);
            } else {
                alert("تم الإرسال بنجاح!");
                location.reload();
            }
        }

        async function loadNotifications() {
            try {
                const { data, error } = await _sb.from('notifications')
                    .select('*, recipient:profiles(username)')
                    .order('created_at', { ascending: false }).limit(20);

                document.getElementById('loading').style.display = 'none';
                const list = document.getElementById('notif-list');

                if (data && data.length) {
                    list.innerHTML = data.map(n => `
                        <div class="notif-card">
                            <div class="notif-header">
                                <span>${n.title}</span>
                                <small>${n.type === 'general' ? 'عام' : 'خاص لـ ' + (n.recipient?.username || 'مستخدم')}</small>
                            </div>
                            <p>${n.message}</p>
                            <small style="color:#999">${new Date(n.created_at).toLocaleString('ar-EG')}</small>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = "<p style='text-align:center;'>لا توجد إشعارات حالياً.</p>";
                }
            } catch (e) {
                console.error(e);
            }
        }

        window.onload = initPage;
    </script>
</body>
</html>
