<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª | ÙÙ„Ø§Ù…Ù†ÙƒÙˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --main: #d63384; --secondary: #9d174d; --bg: #f8f9fa; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); direction: rtl; margin: 0; padding: 15px; }
        
        .header { background: linear-gradient(135deg, var(--main), var(--secondary)); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(214, 51, 132, 0.2); }
        .container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        
        h2 { color: var(--main); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.1rem; margin-top: 0; }
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 14px; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.3s; background: #fff; }
        input:focus { border-color: var(--main); }
        
        .btn { background: var(--main); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        
        .notif-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-right: 5px solid var(--main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .notif-header { display: flex; justify-content: space-between; font-weight: bold; color: var(--main); margin-bottom: 5px; font-size: 14px; }
        
        #suggestions { border: 1px solid #ddd; display: none; max-height: 200px; overflow-y: auto; background: white; position: absolute; width: 100%; z-index: 100; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); top: 70px; }
        .user-suggestion { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; color: #333; }
        .user-suggestion:hover { background: #fdf2f8; }
        
        .back-btn { display: inline-flex; align-items: center; gap: 8px; margin-bottom: 15px; color: var(--main); text-decoration: none; font-weight: bold; font-size: 14px; }
        #loading { text-align: center; padding: 30px; color: #999; }
    </style>
</head>
<body>

    <a href="admin-index.html" class="back-btn"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

    <div class="header">
        <h1><i class="fas fa-bell"></i> Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h1>
        <p style="margin:5px 0 0;">Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡</p>
    </div>

    <div class="container">
        <h2><i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
        
        <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
            <select id="type" onchange="toggleUserSection(this.value)">
                <option value="general">Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù… (Ù„Ù„Ø¬Ù…ÙŠØ¹)</option>
                <option value="private">Ø¥Ø´Ø¹Ø§Ø± Ø®Ø§Øµ (Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯)</option>
                <option value="warning">ØªØ­Ø°ÙŠØ± (Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯)</option>
            </select>
        </div>

        <div class="form-group" id="user-sec" style="display:none;">
            <label>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" id="user-search" oninput="searchUsers(this.value)" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." autocomplete="off">
            <div id="suggestions"></div>
            <input type="hidden" id="target-id">
            <div id="selected-name" style="margin-top:8px; color: #16a34a; font-size: 13px; font-weight: bold;"></div>
        </div>

        <div class="form-group">
            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù…Ø«Ù„Ø§Ù‹: ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙŠØ¯)">
        </div>

        <div class="form-group">
            <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
            <textarea id="message" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§..."></textarea>
        </div>

        <button class="btn" id="sendBtn" onclick="sendNotif()">
            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        </button>
    </div>

    <div class="container">
        <h2><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
        <div id="loading"><i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div id="notif-list"></div>
    </div>

    <script>
        const S_URL = 'https://yboxheficowekfzjatti.supabase.co';
        const S_KEY = 'sb_publishable_a482mpjOWq2R5Bil808Vng_DObZcycS'; 
        const _sb = window.supabase.createClient(S_URL, S_KEY);
        let allUsers = [];

        async function initPage() {
            try {
                // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø¨Ø­Ø«
                const { data: usersData } = await _sb.from('profiles').select('id, username, email').limit(1000);
                allUsers = usersData || [];
                loadNotifications();
            } catch (err) {
                document.getElementById('loading').innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
            }
        }

        function toggleUserSection(val) {
            document.getElementById('user-sec').style.display = (val === 'general') ? 'none' : 'block';
        }

        function searchUsers(query) {
            const sugBox = document.getElementById('suggestions');
            if (!query) { sugBox.style.display = 'none'; return; }

            const filtered = allUsers.filter(u => 
                (u.username && u.username.toLowerCase().includes(query.toLowerCase())) || 
                (u.email && u.email.toLowerCase().includes(query.toLowerCase()))
            ).slice(0, 5);

            sugBox.innerHTML = filtered.map(u => `
                <div class="user-suggestion" onclick="selectUser('${u.id}', '${u.username || u.email}')">
                    <i class="fas fa-user"></i> ${u.username || 'Ù…Ø³ØªØ®Ø¯Ù…'} <br>
                    <small style="color:#999">${u.email}</small>
                </div>
            `).join('');
            sugBox.style.display = filtered.length ? 'block' : 'none';
        }

        function selectUser(id, name) {
            document.getElementById('target-id').value = id;
            document.getElementById('selected-name').innerText = "âœ… ØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±: " + name;
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('user-search').value = name;
        }

        async function sendNotif() {
            const title = document.getElementById('title').value.trim();
            const message = document.getElementById('message').value.trim();
            const type = document.getElementById('type').value;
            const targetId = document.getElementById('target-id').value;
            const btn = document.getElementById('sendBtn');

            if (!title || !message) return alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰");
            if (type !== 'general' && !targetId) return alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

            const { error } = await _sb.from('notifications').insert([{
                title: title,
                message: message,
                type: type,
                recipient_id: type === 'general' ? null : targetId
            }]);

            if (error) {
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±';
            } else {
                alert("ğŸš€ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!");
                location.reload();
            }
        }

        async function loadNotifications() {
            try {
                const { data, error } = await _sb.from('notifications')
                    .select('*, recipient:profiles(username)')
                    .order('created_at', { ascending: false }).limit(10);

                document.getElementById('loading').style.display = 'none';
                const list = document.getElementById('notif-list');

                if (data && data.length) {
                    list.innerHTML = data.map(n => `
                        <div class="notif-card">
                            <div class="notif-header">
                                <span>${n.title}</span>
                                <span class="count" style="font-size:10px">${n.type === 'general' ? 'Ø¹Ø§Ù…' : 'Ø®Ø§Øµ'}</span>
                            </div>
                            <p style="margin:5px 0; font-size:14px; color:#444;">${n.message}</p>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                                <small style="color:#aaa">${new Date(n.created_at).toLocaleDateString('ar-EG')}</small>
                                ${n.recipient?.username ? `<small style="color:var(--main)">Ù„Ù€: ${n.recipient.username}</small>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = "<p style='text-align:center; color:#999;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.</p>";
                }
            } catch (e) {
                console.error(e);
            }
        }

        window.onload = initPage;
    </script>
</body>
</html>
